<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sankey Diagram</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body{
  margin:0;
  padding:24px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
svg{
  width:1600px;
  height:900px;
  border:1px solid #e8e8e8;
  border-radius:12px;
  background:#fff;
}
.node{
  stroke:#000;
  stroke-width:0.4px;
}
.link{
  fill:none;
  stroke-opacity:0.35;
}
.label{
  font-size:11px;
  dominant-baseline:middle;
}
.header{
  font-size:22px;
  font-weight:900;
}
</style>
</head>

<body>
<h2>Studies → Tasks → Categories  </h2>
<svg id="viz" viewBox="0 0 1600 900"></svg>

<script>
const width = 1600, height = 900;
const margin = {top:70, bottom:30};
const innerHeight = height - margin.top - margin.bottom;

const svg = d3.select("#viz");

d3.json("modified_visualization_data.json").then(data => {

  /* ---------- Helpers ---------- */
  const isStudy = d => d.group === "study";
  const isTask = d => d.group === "task";
  const isCategory = d => d.group === "category";

  /* ---------- Sort nodes ---------- */
  const studies = data.nodes.filter(isStudy)
    .sort((a,b)=>+a.id.replace("Study ","")-+b.id.replace("Study ",""));

  const tasks = data.nodes.filter(isTask)
    .sort((a,b)=>+a.id.match(/\d+/)-+b.id.match(/\d+/));

  const categories = data.nodes.filter(isCategory)
    .sort((a,b)=>+a.id.match(/^\d+/)-+b.id.match(/^\d+/));

  /* ---------- Task connections ---------- */
  const studyTask = data.links.filter(l=>l.source.startsWith("Study"));
  const taskCategory = data.links.filter(l=>l.target.match(/^\d+\./));

  const studyCounts = d3.rollup(studyTask, v=>v.length, d=>d.source);
  const categoryCounts = d3.rollup(taskCategory, v=>v.length, d=>d.target);

  /* ---------- Vertical scales (INDEPENDENT) ---------- */
  const taskScale = d3.scaleBand()
    .domain(tasks.map(d=>d.id))
    .range([margin.top, margin.top + innerHeight])
    .padding(0);

  const studyScale = d3.scaleLinear()
    .domain([0, d3.sum(studyCounts.values())])
    .range([margin.top, margin.top + innerHeight]);

  const categoryScale = d3.scaleLinear()
    .domain([0, d3.sum(categoryCounts.values())])
    .range([margin.top, margin.top + innerHeight]);

  /* ---------- Layout positions ---------- */
  const studyPos = new Map();
  let acc = 0;
  studies.forEach(s=>{
    const h = studyCounts.get(s.id) || 0;
    studyPos.set(s.id, {
      y: studyScale(acc),
      h: studyScale(acc + h) - studyScale(acc)
    });
    acc += h;
  });

  const categoryPos = new Map();
  acc = 0;
  categories.forEach(c=>{
    const h = categoryCounts.get(c.id) || 0;
    categoryPos.set(c.id, {
      y: categoryScale(acc),
      h: categoryScale(acc + h) - categoryScale(acc)
    });
    acc += h;
  });

  /* ---------- Colors ---------- */
  const studyColor = d3.scaleOrdinal()
    .domain(studies.map(d=>d.id))
    .range(d3.quantize(d3.interpolateRainbow, studies.length));

  const categoryColor = d3.scaleOrdinal()
    .domain(categories.map(d=>d.id))
    .range(d3.quantize(d3.interpolateRainbow, categories.length));

  /* ---------- Draw headers ---------- */
  const cols = [
    {x:200, label:"Study"},
    {x:700, label:"Task"},
    {x:1200, label:"Category"}
  ];

  svg.selectAll(".header")
    .data(cols)
    .join("text")
    .attr("class","header")
    .attr("x",d=>d.x)
    .attr("y",40)
    .attr("text-anchor","middle")
    .text(d=>d.label);

  /* ---------- Draw nodes ---------- */
  svg.selectAll(".study")
    .data(studies)
    .join("rect")
    .attr("class","node")
    .attr("x",180)
    .attr("y",d=>studyPos.get(d.id).y)
    .attr("width",40)
    .attr("height",d=>studyPos.get(d.id).h)
    .attr("fill",d=>studyColor(d.id));

  svg.selectAll(".task")
    .data(tasks)
    .join("rect")
    .attr("class","node")
    .attr("x",680)
    .attr("y",d=>taskScale(d.id))
    .attr("width",40)
    .attr("height",taskScale.bandwidth())
    .attr("fill","#0c7f86");

  svg.selectAll(".category")
    .data(categories)
    .join("rect")
    .attr("class","node")
    .attr("x",1180)
    .attr("y",d=>categoryPos.get(d.id).y)
    .attr("width",40)
    .attr("height",d=>categoryPos.get(d.id).h)
    .attr("fill",d=>categoryColor(d.id));

});
</script>
</body>
</html>
