<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Task Analysis Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background: #f4f4f7; overflow: hidden; }
        svg { width: 100vw; height: 100vh; cursor: crosshair; }
        
        /* Links */
        .links line { stroke: #999; stroke-opacity: 0.15; transition: stroke 0.3s, stroke-opacity 0.3s; }
        .links line.active { stroke: #d63031; stroke-opacity: 0.9 !important; }
        .links line.dimmed { stroke-opacity: 0.03 !important; }

        /* Nodes */
        circle { stroke: #fff; stroke-width: 2px; transition: opacity 0.3s, transform 0.2s; cursor: pointer; }
        circle.dimmed { opacity: 0.15; }
        circle.active { stroke: #000; stroke-width: 3px; }

        /* Labels */
        text { font-size: 11px; fill: #444; pointer-events: none; transition: opacity 0.3s; }
        .cat-label { font-size: 13px; font-weight: bold; fill: #1a1a1a; }
        .score-label { font-size: 16px; font-weight: 800; fill: #d63031; opacity: 0; }
        .score-label.show { opacity: 1; }
        text.dimmed { opacity: 0.1; }

        /* UI */
        .ui-overlay { position: absolute; top: 20px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); pointer-events: none; border: 1px solid #ddd; }
        .instruction { font-size: 12px; color: #666; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

<div class="ui-overlay">
    <strong style="font-size: 15px;">Task Focus Map</strong>
    <div style="margin-top:8px; font-size: 13px;">
        <span style="color: #2ca02c;">●</span> Categories (Top)<br>
        <span style="color: #1f77b4;">●</span> Tasks (Middle)<br>
        <span style="color: #ff7f0e;">●</span> Studies (Bottom)
    </div>
    <div class="instruction">Click a Task to see link values.<br>Click background to reset.</div>
</div>

<svg id="viz"></svg>

<script>
    d3.json("modified_visualization_data.json").then(function(graph) {
        const svg = d3.select("#viz"),
            width = window.innerWidth,
            height = window.innerHeight;

        const tiers = { "category": height * 0.18, "task": height * 0.5, "study": height * 0.82 };
        const colors = { "study": "#ff7f0e", "task": "#1f77b4", "category": "#2ca02c" };

        // Dynamic Sizing
        const catNodes = graph.nodes.filter(n => n.group === 'category');
        const radiusScale = d3.scaleSqrt()
            .domain([0, d3.max(catNodes, d => d.count || 0)])
            .range([15, 40]);

        const simulation = d3.forceSimulation(graph.nodes)
            .force("link", d3.forceLink(graph.links).id(d => d.id).distance(80).strength(0.3))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("y", d3.forceY(d => tiers[d.group]).strength(1.5))
            .force("x", d3.forceX(width / 2).strength(0.08))
            .force("collision", d3.forceCollide().radius(d => d.group === 'category' ? 50 : 30));

        // Create Link Groups
        const linkGroup = svg.append("g").attr("class", "links")
            .selectAll("g")
            .data(graph.links)
            .enter().append("g");

        const linkLine = linkGroup.append("line")
            .attr("stroke-width", d => d.value > 1 ? (d.value * 0.6) : 1);

        // Score labels (hidden by default)
        const scoreLabel = linkGroup.append("text")
            .attr("class", "score-label")
            .attr("text-anchor", "middle")
            .text(d => d.value > 1 ? d.value : "");

        // Nodes
        const node = svg.append("g")
            .selectAll("g")
            .data(graph.nodes)
            .enter().append("g")
            .on("click", (event, d) => {
                event.stopPropagation();
                if (d.group === 'task') highlightTask(d);
            })
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

        const circles = node.append("circle")
            .attr("r", d => d.group === 'category' ? radiusScale(d.count || 0) : (d.group === 'study' ? 10 : 7))
            .attr("fill", d => colors[d.group]);

        const labels = node.append("text")
            .attr("class", d => d.group === 'category' ? "cat-label" : "")
            .attr("text-anchor", d => d.group === 'category' ? "middle" : "start")
            .attr("dx", d => d.group === 'category' ? 0 : 15)
            .attr("dy", d => d.group === 'category' ? 5 : 4)
            .text(d => d.id);

        // Reset on background click
        svg.on("click", resetHighlight);

        function highlightTask(selectedTask) {
            const connectedCategoryIds = graph.links
                .filter(l => l.source.id === selectedTask.id)
                .map(l => l.target.id);

            // 1. Dim everything
            circles.classed("dimmed", true).classed("active", false);
            linkLine.classed("dimmed", true).classed("active", false);
            labels.classed("dimmed", true);
            scoreLabel.classed("show", false);

            // 2. Highlight selected Task
            d3.select(circles.nodes()[selectedTask.index]).classed("dimmed", false).classed("active", true);
            d3.select(labels.nodes()[selectedTask.index]).classed("dimmed", false);

            // 3. Highlight connected Links and Categories
            linkGroup.each(function(l) {
                if (l.source.id === selectedTask.id) {
                    d3.select(this).select("line").classed("dimmed", false).classed("active", true);
                    d3.select(this).select(".score-label").classed("show", true);
                    
                    // Highlight the target Category node
                    const targetNode = graph.nodes.find(n => n.id === l.target.id);
                    d3.select(circles.nodes()[targetNode.index]).classed("dimmed", false);
                    d3.select(labels.nodes()[targetNode.index]).classed("dimmed", false);
                }
            });
        }

        function resetHighlight() {
            circles.classed("dimmed", false).classed("active", false);
            linkLine.classed("dimmed", false).classed("active", false);
            labels.classed("dimmed", false);
            scoreLabel.classed("show", false);
        }

        simulation.on("tick", () => {
            node.each(d => {
                const r = d.group === 'category' ? radiusScale(d.count || 0) : 15;
                d.x = Math.max(r + 50, Math.min(width - r - 50, d.x));
                d.y = Math.max(r, Math.min(height - r, d.y));
            });

            linkLine.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

            // Position score labels at 75% of the way to the category (closer to the top)
            scoreLabel.attr("x", d => d.source.x + (d.target.x - d.source.x) * 0.75)
                      .attr("y", d => d.source.y + (d.target.y - d.source.y) * 0.75 - 10);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x; event.subject.fy = event.subject.y;
        }
        function dragged(event) { event.subject.fx = event.x; event.subject.fy = event.y; }
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null; event.subject.fy = null;
        }
    });
</script>
</body>
</html>
